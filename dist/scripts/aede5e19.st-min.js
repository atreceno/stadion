"use strict";angular.module("stadion",["mongoLabApi","ui.bootstrap","helper"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"partials/main.html",controller:"MainCtrl"}).when("/countries",{templateUrl:"partials/country-list.html",controller:"CountryListCtrl"}).when("/countries/edit/:countryId",{templateUrl:"partials/country-detail.html",controller:"CountryEditCtrl"}).when("/countries/new",{templateUrl:"partials/country-detail.html",controller:"CountryNewCtrl"}).when("/tournaments/search/:tournamentName",{templateUrl:"partials/tournament-list.html",controller:"TournamentListCtrl"}).when("/tournaments/view/:tournamentId",{templateUrl:"partials/tournament-view.html",controller:"TournamentViewCtrl"}).when("/tournaments/new",{templateUrl:"partials/tournament-new.html",controller:"TournamentNewCtrl"}).otherwise({redirectTo:"/"})}]);var stadion=angular.module("stadion");stadion.controller("CountryListCtrl",["$scope","Country",function(a,b){a.countries=b.query(),a.query="",a.predicate=["gold","silver","bronze"],a.reverse="true",a.sort="false"}]),stadion.controller("CountryEditCtrl",["$scope","$location","$routeParams","Country",function(a,b,c,d){var e=this;d.get({id:c.countryId},function(b){e.original=b,a.country=new d(e.original)}),a.isClean=function(){return angular.equals(e.original,a.country)},a.destroy=function(){e.original.destroy(function(){b.path("/countries")})},a.save=function(){a.country.update(function(){b.path("/countries")})}}]),stadion.controller("CountryNewCtrl",["$scope","$location","Country",function(a,b,c){a.save=function(){c.save(a.country,function(){b.path("/countries")})}}]);var stadion=angular.module("stadion");stadion.controller("TournamentListCtrl",["$scope","$routeParams","$location","Tournament","Sport",function(a,b,c,d,e){a.tName=b.tournamentName,a.tSport=b.sport,a.tLocation=b.location,a.predicates=["name","location","sport"],a.itemsPerPage=[25,50,100],a.sports=e.query({f:JSON.stringify({_id:0,name:1})}),a.locations=["London, UK"],a.currentPage=1,a.maxSize=5,a.sortBy="name",a.pageSize=25;var f=function(a,b,c,d,e,f,g){var h={};if(a||b||c){var i={};a&&(i.name={$regex:a,$options:"i"}),b&&(i.sport=b),c&&(i.location=c),h.q=JSON.stringify(i)}if(d)h.c=!0;else{h.f=JSON.stringify({name:1,description:1,location:1,sport:1});var j={};j[e]=1,h.s=JSON.stringify(j),h.sk=g*(f-1),h.l=g}return h};a.search=function(b,c){a.count=d.count(f(a.tName,a.tSport,a.tLocation,!0)).success(function(b){a.noOfPages=Math.ceil(b/a.pageSize)}),a.sortBy=b,a.pageSize=c;var e=f(a.tName,a.tSport,a.tLocation,!1,b,a.currentPage,c);a.tournaments=d.query(e)},a.$watch("currentPage",function(){a.search(a.sortBy,a.pageSize)})}]),stadion.controller("TournamentViewCtrl",["$scope","$routeParams","Tournament",function(a,b,c){var d=this;c.get({id:b.tournamentId},function(b){d.original=b,a.tournament=new c(d.original)})}]),stadion.controller("TournamentNewCtrl",["$scope","$location","Tournament","Duel",function(a,b,c,d){a.options={nums:[2,3,4,5,6,7,8],types:["Individuals","Couples","Teams"],systems:[{name:"Single Round-Robin",type:"Group Tournament"},{name:"Double Round-Robin",type:"Group Tournament"},{name:"Single Elimination",type:"Knock-Out Tournament"},{name:"Double Elimination",type:"Knock-Out Tournament"},{name:"Group + Knock-Out",type:"Multi-Stage Tournament"}]},a.tournament={},a.tournament.numOfCompetitors=a.options.nums[0],a.tournament.typeOfCompetitors=a.options.types[0],a.save=function(){a.tournament.competitors=[];for(var b=a.tournament.numOfCompetitors,c=0;b>c;c++)a.tournament.competitors.push({seed:c+1,name:""});var e=new d(b,1);console.log(e.matches.length)}}]);var stadion=angular.module("stadion");stadion.controller("MainCtrl",["$scope","$dialog","Feedback",function(a,b,c){a.open=function(){a.shouldBeOpen=!0,a.feedback={name:"",email:"",message:""}},a.close=function(){a.shouldBeOpen=!1},a.opts={backdrop:!0,keyboard:!0,backdropClick:!0,dialogFade:!0,backdropFade:!0,templateUrl:"partials/feedback.html",controller:"DialogCtrl"},a.opts2={backdropFade:!0,dialogFade:!0},a.send=function(){c.save(a.feedback,function(){console.log("Feedback sent successfully"),a.shouldBeOpen=!1})},a.openFb=function(){b.dialog(a.opts).open().then(function(a){console.log(a)})},a.widgets=["one","two","three"]}]),stadion.controller("DialogCtrl",["$scope","dialog","Feedback",function(a,b,c){a.closeFb=function(a){b.close(a)},a.sendFb=function(d){c.save(a.feedback,function(){console.log("Feedback sent successfully")}),b.close(d)}}]),stadion.controller("bmCtrl",["$scope","Feedback",function(a,b){a.send=function(){b.save(a.feedback,function(){console.log("Feedback sent successfully"),a.isSent=!0})}}]),angular.module("localRestApi",["ngResource"]).factory("Country",["$resource",function(a){var b=a("/api/countries/:id",{},{update:{method:"PUT"}});return b.prototype.update=function(a){return b.update({id:this._id},angular.extend({},this,{_id:void 0}),a)},b.prototype.destroy=function(a){return b.remove({id:this._id},a)},b}]);var mongoLabApi=angular.module("mongoLabApi",["ngResource"]);mongoLabApi.factory("Country",["$resource",function(a){var b=a("https://api.mongolab.com/api/1/databases/stadion/collections/countries/:id",{apiKey:"yjCay7qWRojHdBsbhp10CJegJRnzbkTJ"},{update:{method:"PUT"}});return b.prototype.update=function(a){return b.update({id:this._id.$oid},angular.extend({},this,{_id:void 0}),a)},b.prototype.destroy=function(a){return b.remove({id:this._id.$oid},a)},b}]),mongoLabApi.factory("Tournament",["$resource","$http",function(a,b){var c="https://api.mongolab.com/api/1/databases/stadion/collections/tournaments/:id",d=a(c,{apiKey:"yjCay7qWRojHdBsbhp10CJegJRnzbkTJ"},{update:{method:"PUT"}});return d.count=function(a){var c={};return c.method="GET",c.url="https://api.mongolab.com/api/1/databases/stadion/collections/tournaments",a.apiKey="yjCay7qWRojHdBsbhp10CJegJRnzbkTJ",c.params=a,b(c)},d.prototype.update=function(a){return d.update({id:this._id.$oid},angular.extend({},this,{_id:void 0}),a)},d.prototype.destroy=function(a){return d.remove({id:this._id.$oid},a)},d}]),mongoLabApi.factory("Sport",["$resource",function(a){var b=a("https://api.mongolab.com/api/1/databases/stadion/collections/sports/:id",{apiKey:"yjCay7qWRojHdBsbhp10CJegJRnzbkTJ"},{update:{method:"PUT"}});return b}]),mongoLabApi.factory("Feedback",["$resource",function(a){var b=a("https://api.mongolab.com/api/1/databases/stadion/collections/feedbacks/:id",{apiKey:"yjCay7qWRojHdBsbhp10CJegJRnzbkTJ"},{update:{method:"PUT"}});return b.prototype.update=function(a){return b.update({id:this._id.$oid},angular.extend({},this,{_id:void 0}),a)},b}]);var helper=angular.module("helper",[]);helper.factory("Duel",function(){function a(a,b,c,d){this.numPlayers=a,this.p=Math.ceil(Math.log(a)/Math.log(2)),this.last=b,this.isLong=!0,this.limit=0,c&&(this.isLong=!c.short,this.limit=c.limit||0),this.right=u.bind(this),this.down=v.bind(this),this.matches=d||t(a,this.p,this.last,this.isLong)}var b={odd:function(a){return a%2===1},firstBy:function(a,b){for(var c=0,d=b.length;d>c;c+=1)if(a(b[c]))return b[c]},maximum:{},flatten:function(a){return[].concat.apply(a)},pluck:function(a,b){for(var c=[],d=0,e=b.length;e>d;d+=1)c[d]=b[d][a];return c},get:function(){var a=arguments;return function(b){for(var c=b,d=0;d<a.length&&void 0!==c;d+=1)c=c[a[d]];return c}}},c={WO:-1,NA:0,WB:1,LB:2,TB:3};c.findMatch=function(a,b){for(var c=0;c<a.length;c+=1){var d=a[c];if(d.id.s===b.s&&d.id.r===b.r&&d.id.m===b.m)return d}},c.compareMatches=function(a,b){return a.id.s-b.id.s||a.id.r-b.id.r||a.id.m-b.id.m},c.compareZip=function(a,b){return b[1]-a[1]||a[0]-b[0]},c.compareRes=function(a,b){return a.pos-b.pos||a.seed-b.seed};var d=["Bronze final","Grand final","Semi-finals","Quarter-finals","Round of "],e=["WB Final","WB Semi-finals","WB Quarter-finals","WB Round of "],f=["Grand final","Grand final","LB Strong final","LB Final","LB Round of ","LB Strong round of "],g=function(a,b,c,g){var h=g.s,i=g.r;if(!Number.isFinite(i)||1>i||[a.WB,a.LB].indexOf(h)<0)throw new Error("invalid partial id for roundName: "+g);var j=h===a.WB&&i>c,k=b===a.WB&&h>=a.LB&&1!==i,l=b===a.LB&&i>2*c;if(j||k||l){var m="br="+h+", last="+b;throw new Error("invalid round number "+i+" given for elimination: "+m)}return b===a.WB?h===a.LB?d[0]:i>c-3?d[c-i+1]:d[4]+Math.pow(2,c-i+1):h===a.WB?i>c-3?e[c-i]:e[3]+Math.pow(2,c-i+1):h===a.LB?i>=2*c-3?f[2*c-i]:i%2===1?f[4]+Math.pow(2,c-(i+1)/2):f[5]+Math.pow(2,c-i/2):void 0},h=c.WB,i=c.LB,j=c.NA,k=c.WO,l=["invalid","single","double","triple"],m=function(a,b){return a.map(function(a){return a>b?k:a})},n=function(a,b,c){return{s:a,r:b,m:c}},o=function(a){var b="";return a.s===c.WB?b="WB ":a.s===c.LB&&(b="LB "),b+"R"+a.r+" M"+a.m},p=function(a,b){var c=Math.floor(Math.log(a)/Math.log(2)),d=a-Math.pow(2,c);if(0===d)return Math.pow(2,b-c);var e=(a-2*d).toString(2).split("").reverse().join("");return parseInt(e,2)/b-e.length+Math.pow(2,b-c-1)},q=function(a,b){var c=p(a,b);return[Math.pow(2,b)+1-c,c]},r=function(a,b,c){for(var d,e,f,g=Math.pow(2,b),l=[],o=1;g/2>=o;o+=1){var p=m(q(o,b),a),r=Number(o%2===0),s={id:n(h,1,o),p:p};if(!r){var t=(o+1)/2;f={id:n(h,2,t),p:[j,j]},c>=i&&(d={id:n(i,1,t),p:[j,j]},e={id:n(i,2,t),p:[j,j]})}(p[0]===k||p[1]===k)&&(f.p[r]=p[Number(p[0]===k)],s.m=p[0]===k?[0,1]:[1,0],c>=i&&(d.p[r]=k,d.p[0]===k&&d.p[1]===k&&(e.p[Number(!r)]=k,d.m=[1,0]))),l.push(s),r&&(l.push(f),c>=i&&l.push(d,e))}return l},s=function(a,b,c){return!Number.isFinite(a)||Math.ceil(a)!==a||4>a||a>1024?"duel tournament size must be an integer n, s.t. 4 <= n <= 1024":[h,i].indexOf(b)<0?"last Duel elimination bracket must be t.WB or t.LB":c.limit?"Duel limits are not yet supported - Duel must be the last stage":null},t=function(a,b,d,e){var f=s(a,d,{limit:0,"short":!e});if(null!==f)return console.log("invalid Duel configuration %dp in %s elimination",a,l[d]||"invalid"),console.log("reason: ",f),[];var g,k,m=r(a,b,d);for(g=3;b>=g;g+=1)for(k=1;k<=Math.pow(2,b-g);k+=1)m.push({id:n(h,g,k),p:[j,j]});if(d===h&&e&&m.push({id:n(i,1,1),p:[j,j]}),d>=i){for(g=3;2*b-2>=g;g+=1)for(k=1;k<=Math.pow(2,b-1-Math.floor((g+1)/2));k+=1)m.push({id:n(i,g,k),p:[j,j]});m.push({id:n(i,2*b-1,1),p:[j,j]}),e&&m.push({id:n(i,2*b,1),p:[j,j]})}return m.sort(c.compareMatches)},u=function(a,c){var d=a.s,e=a.r,f=a.m,g=this.p,j=this.last,k=this.isLong,l=j===h&&e===g,m=j===i&&d===i&&e===2*g,o=j===h&&d===i,p=!(d!==i||e!==2*g-1||k&&c);if(l||m||o||p)return null;if(j>=i&&d===h&&e===g)return[n(i,2*g-1,1),0];var q,r=d===i&&b.odd(e)?f:Math.floor((f+1)/2);return q=d===h?(f+1)%2:e===2*g-2?1:e===2*g-1?0:1===e?f%2:b.odd(e)?1:(f+1)%2,[n(d,e+1,r),q]},v=function(a,c){var d=a.s,e=a.r,f=a.m,g=this.p,j=this.last,k=this.isLong;if(d>=j)return d===h&&k&&e===g-1?[n(i,1,1),(f+1)%2]:d===i&&e===2*g-1&&k&&c?[n(i,2*g,1),1]:null;var l=e>2||b.odd(f)?0:1,m=1===e?n(i,1,Math.floor((f+1)/2)):n(i,2*(e-1),f);return[m,l]},w=function(a,b,d,e){var f=c.findMatch(a,b);return f?f.p[0]===k||f.p[1]===k?"cannot override score in walkover match":f.p[0]===j||f.p[1]===j?"match not ready - missing players":Array.isArray(d)&&d.every(Number.isFinite)?2!==d.length||d[0]===d[1]?"scores must have length 2 and cannot draw":!e&&Array.isArray(f.m)?"cannot re-score match":null:"scores must be a numeric array":"match not found in tournament"},x=function(a,b,d,e,f){var g=w(d,e,f,!0);if(null!==g)return console.log("failed scoring Duel match %s with %j",o(e),f),console.log("reason:",g),!1;var h=c.findMatch(d,e);h.m=f;var i=function(a,b){if(a){var e=a[0],f=a[1],g=c.findMatch(d,e);if(!g){var h=o(e);throw new Error("tournament corrupt: "+h+" not found!")}if(g.p[f]=b,g.p[(f+1)%2]===k)return g.m=f?[0,1]:[1,0],g.id}},j=f[0]>f[1]?h.p[0]:h.p[1],l=f[0]>f[1]?h.p[1]:h.p[0],m=j===h.p[1];i(a(e,m),j);var n=i(b(e,m),l);return n&&i(a(n,!1),l),!0},y=function(a,b){var c=2*a-b,d=Math.floor(c/2)-1;if(0>d)throw new Error("lbPos model works for k>=0 only");var e=Math.pow(2,d)*(c%2);return Math.pow(2,d+1)+1+e},z=function(a,b){return Math.pow(2,a-b)+1},A=function(a,b,c){return a===i?y(b,c):z(b,c)},B=function(a,b){for(var d=this.last,e=this.p,f=this.isLong,g=new Array(this.numPlayers),j=0;j<this.numPlayers;j+=1)g[j]={seed:j+1,maps:0,wins:0};for(var l=0;l<a.length;l+=1){for(var m=a[l],n=f&&d===h&&m.id.s===i,o=d===h&&m.id.s===h&&m.id.r===e,p=d===i&&m.id.s===i&&m.id.r>=2*e-1,q=f&&d===h&&m.id.s===h&&m.id.r===e-1,r=!(n||o||p||q),s=d===i&&m.id.s===h?b(m.id,!1)[0].r:m.id.r,t=0;t<m.p.length;t+=1){var u=m.p[t]-1;if(u>=0){var v=2+2*Number(n||q);g[u].pos=r?A(d,e,s):v}}if(m.p[0]!==k&&m.p[1]!==k&&m.m){var w=m.p[0]-1,x=m.p[1]-1,y=m.m[0]>m.m[1]?w:x,z=m.m[0]>m.m[1]?x:w;g[y].wins+=1,g[w].maps+=m.m[0],g[x].maps+=m.m[1],n?(g[z].pos=4,g[y].pos=3):o?(g[z].pos=2,g[y].pos=1):p&&(g[z].pos=2,g[y].pos=m.id.r!==2*e&&f&&w!==y?2:1)}}return g.sort(c.compareRes)},C=function(a,c){var d=b.firstBy(function(a){return a.p.indexOf(c)>=0&&!a.m},a);return d?d.id:void 0};return a.fromJSON=function(d,e){if(!d.length)return console.log("cannot recreate tournament - no matches found"),void 0;var f=d.filter(function(a){return a.id.s===i}).length,g=f>1?i:h,j=b.maximum(b.flatten(b.pluck("p",d))),k=Math.ceil(Math.log(j)/Math.log(2)),l=c.findMatch(d,{s:i,r:2*k,m:1}),m=g===h&&0===f||g===i&&!l;return new a(j,g,{"short":m,limit:e},d)},a.invalid=s,a.idString=o,a.prototype.unscorable=function(a,b,c){return w(this.matches,a,b,c)},a.prototype.score=function(a,b){return x(this.right,this.down,this.matches,a,b)},a.prototype.roundName=function(a){return g({LB:i,WB:h},this.last,this.p,a)},a.prototype.isDone=function(){if(!this.isLong){var a=this.matches[this.matches.length-1];return Array.isArray(a.m)}if(this.matches.every(b.get("m")))return!0;var c=this.matches[this.matches.length-2];return this.last===i&&Array.isArray(c.m)&&c.m[0]>c.m[1]},a.prototype.upcoming=function(a){return C(this.matches,a)},a.prototype.results=function(){return B.call(this,this.matches,this.down)},a}),helper.factory("RoundRobin",function(){}),angular.module("stadion").directive("stMedal",function(){var a={top:20,right:20,bottom:30,left:40},b=700-a.left-a.right,c=350-a.top-a.bottom,d=d3.scale.ordinal().rangeRoundBands([0,b],.1,.2),e=d3.scale.linear().range([c,0]),f=d3.svg.axis().scale(d).orient("bottom"),g=d3.svg.axis().scale(e).orient("left").tickFormat(d3.format("d"));return{scope:{data:"=",sort:"="},restrict:"A",link:function(b,h,i){console.log(i);var j=d3.select(h[0]).append("svg").attr("viewBox","0 0 700 350").attr("preserveAspectRatio","xMinYMin meet").append("g").attr("transform","translate("+a.left+","+a.top+")");b.$watch("data.length",function(a){if(0!==a){var h=b.data;console.log("data: "+h),d.domain(h.map(function(a){return a.name})),e.domain([0,d3.max(h,function(a){return a.gold})]),j.append("g").attr("class","x axis").attr("transform","translate(0,"+c+")").call(f),j.append("g").attr("class","y axis").call(g).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Gold Medals"),j.selectAll(".bar").data(h).enter().append("rect").attr("class","bar").attr("x",function(a){return d(a.name)}).attr("width",d.rangeBand()).attr("y",function(a){return e(a.gold)}).attr("height",function(a){return c-e(a.gold)})}},!1),b.$watch("sort",function(a){var c=b.data;if(0!==c.length){console.log("sort: "+a);var e=d.domain(c.sort(a?function(a,b){return b.gold-a.gold}:function(a,b){return d3.ascending(a.name,b.name)}).map(function(a){return a.name})).copy(),g=j.transition().duration(750),h=function(a,b){return 50*b};g.selectAll(".bar").delay(h).attr("x",function(a){return e(a.name)}),g.select(".x.axis").call(f).selectAll("g").delay(h)}})}}});